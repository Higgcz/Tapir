//
//  TSLZone.m
//  TapirApplication
//
//  Created by Vojtech Micka on 08.05.14.
//  Copyright (c) 2014 Vojtech Micka. All rights reserved.
//

#import "TSLZone.h"
#import "TSLRoad.h"
#import "TSLCar.h"
#import "TSLPath.h"
#import "TSLUniverse.h"
#import "TSLWaypoint.h"

@implementation TSLZone

////////////////////////////////////////////////////////////////////////////////////////////////
- (instancetype) initWithPosition:(NSPoint) position
////////////////////////////////////////////////////////////////////////////////////////////////
{
    self = [super initWithPosition:position];
    if (self) {
        self.cars = [NSMutableArray array];
        self.road = nil;
    }
    return self;
}

////////////////////////////////////////////////////////////////////////////////////////////////
+ (instancetype) zoneAtPosition:(NSPoint) position
////////////////////////////////////////////////////////////////////////////////////////////////
{
    TSLZone *zone = [[TSLZone alloc] initWithPosition:position];
    return zone;
}

////////////////////////////////////////////////////////////////////////////////////////////////
- (void) updateWithTimeSinceLastUpdate:(CFTimeInterval) deltaTime
////////////////////////////////////////////////////////////////////////////////////////////////
{
    if (self.cars.count == 0) return;
    
    TSLPath *path = nil;
    TSLCar *car = (TSLCar *)[self.cars lastObject];
    
    if ((path = [self getFreePathForCar:car]) != nil) {
        // place new car from buffer
        [self.cars removeLastObject];
        
        // Create car in universe
        [self.universe addObject:car];
        
        // Put car into path
        [path putCar:car];
        
        [self.road takeCar:car fromRoadObject:self];
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////
- (NSSet *) pathsForPath:(TSLPath *) path fromRoadObject:(TSLRoadObject *) roadObject
////////////////////////////////////////////////////////////////////////////////////////////////
{
    return nil;
}

////////////////////////////////////////////////////////////////////////////////////////////////
- (NSSet *) pathsNextForPath:(TSLPath *) path
////////////////////////////////////////////////////////////////////////////////////////////////
{
    return nil;
}

////////////////////////////////////////////////////////////////////////////////////////////////
- (TSLPath *) getFreePathForCar:(TSLCar *) car
////////////////////////////////////////////////////////////////////////////////////////////////
{
    return [self.road getFreePathInDirection:[self.road getDirectionFromRoadObject:self] forCar:car];
}

////////////////////////////////////////////////////////////////////////////////////////////////
- (void) takeCar:(TSLCar *) car fromRoadObject:(TSLRoadObject *) roadObject
////////////////////////////////////////////////////////////////////////////////////////////////
{
    // destroy car
//    [self.universe removeObject:car.driver];
//    [self.universe removeObject:car];
}

@end
